version: '3.8'

services:
  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: discount-manager-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - gateway
      - bootstrapper
    networks:
      - discount-manager-network
    restart: unless-stopped

  # API Gateway (Ocelot)
  gateway:
    build:
      context: ../src/Gateway/DiscountManager.Gateway
      dockerfile: Dockerfile
    container_name: discount-manager-gateway
    ports:
      - "5000:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - Jwt__Key=${JWT_KEY}
      - Jwt__Issuer=DiscountManager
      - Jwt__Audience=DiscountManagerClients
    volumes:
      - gateway_logs:/app/logs
    networks:
      - discount-manager-network
    restart: unless-stopped

  # Main Bootstrapper
  bootstrapper:
    build:
      context: ../src/Bootstrapper/DiscountManager.Bootstrapper
      dockerfile: Dockerfile
    container_name: discount-manager-bootstrapper
    ports:
      - "5169:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__CatalogDb=${CATALOG_DB}
      - ConnectionStrings__ShopsDb=${SHOPS_DB}
      - ConnectionStrings__DiscountDb=${DISCOUNT_DB}
      - ConnectionStrings__InventoryDb=${INVENTORY_DB}
      - ConnectionStrings__OrderingDb=${ORDERING_DB}
      - ConnectionStrings__PaymentDb=${PAYMENT_DB}
      - ConnectionStrings__IdentityDb=${IDENTITY_DB}
      - ConnectionStrings__CustomerDb=${CUSTOMER_DB}
      - ConnectionStrings__Redis=${REDIS_CONNECTION}
      - Jwt__Key=${JWT_KEY}
    volumes:
      - bootstrapper_logs:/app/logs
      - static_files:/app/wwwroot
    depends_on:
      - redis
      - sqlserver
    networks:
      - discount-manager-network
    restart: unless-stopped

  # Redis Cache
  redis:
    image: redis:alpine
    container_name: discount-manager-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - discount-manager-network
    restart: unless-stopped

  # SQL Server
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: discount-manager-sqlserver
    ports:
      - "1433:1433"
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=${SQL_SA_PASSWORD}
    volumes:
      - sqlserver_data:/var/opt/mssql
    networks:
      - discount-manager-network
    restart: unless-stopped

  # Vector (Metrics & Logs)
  vector:
    image: timberio/vector:latest-alpine
    container_name: discount-manager-vector
    ports:
      - "8686:8686"  # Vector API
      - "9598:9598"  # Prometheus exporter
    volumes:
      - ./vector/vector.toml:/etc/vector/vector.toml:ro
      - nginx_logs:/var/log/nginx:ro
      - gateway_logs:/var/log/gateway:ro
      - bootstrapper_logs:/var/log/bootstrapper:ro
      - vector_data:/var/lib/vector
    networks:
      - discount-manager-network
    restart: unless-stopped

  # Prometheus (Optional - for metrics visualization)
  prometheus:
    image: prom/prometheus:latest
    container_name: discount-manager-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - discount-manager-network
    restart: unless-stopped

  # Grafana (Optional - for dashboards)
  grafana:
    image: grafana/grafana:latest
    container_name: discount-manager-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - discount-manager-network
    restart: unless-stopped

networks:
  discount-manager-network:
    driver: bridge

volumes:
  nginx_logs:
  gateway_logs:
  bootstrapper_logs:
  vector_data:
  redis_data:
  sqlserver_data:
  static_files:
  prometheus_data:
  grafana_data:
